(()=>{globalThis.ovoLevelEditor={init(){let e=globalThis.sdk_runtime;c2_callFunction("execCode",["globalThis.sdk_runtime = this.runtime"]);let t=globalThis.sdk_runtime;globalThis.sdk_runtime=e;let i=t.layouts["Level Base"],l=i.startRunning.bind(i);i.startRunning=()=>{console.log("start"),globalThis.ovoLevelEditor.applySetup(),l(),globalThis.ovoLevelEditor.applyCurrentLevel()};let a=()=>{t.changelayout=i},s={Solid:t.types_by_index.find(e=>"Solid"===e.name||e.plugin instanceof cr.plugins_.TiledBg&&e.texture_file&&e.texture_file.includes("/solid.png")&&2===e.behs_count),Spike:t.types_by_index.find(e=>"Spike"===e.name||e.plugin instanceof cr.plugins_.Sprite&&e.all_frames&&e.all_frames[0].texture_file.includes("spike-")),Flag:t.types_by_index.find(e=>"EndFlag"===e.name||e.plugin instanceof cr.plugins_.Sprite&&e.all_frames&&e.all_frames[0].texture_file.includes("endflag")),JumpThrough:t.types_by_index.find(e=>"JumpThrough"===e.name||e.plugin instanceof cr.plugins_.TiledBg&&e.texture_file&&e.texture_file.includes("jumpthrough")&&2===e.families.length),GroundPoundSolid:t.types_by_index.find(e=>"GroundPoundSolid"===e.name||e.plugin instanceof cr.plugins_.TiledBg&&e.texture_file&&e.texture_file.includes("groundpoundsolid")&&2===e.families.length),RocketLauncher:t.types_by_index.find(e=>"RocketLauncher"===e.name||e.plugin instanceof cr.plugins_.Sprite&&e.all_frames&&e.all_frames[0].texture_file.includes("rocketlauncher")),JumpBoost:t.types_by_index.find(e=>"JumpBoost"===e.name||e.plugin instanceof cr.plugins_.Sprite&&e.all_frames&&e.all_frames[0].texture_file.includes("jumpboost")),LayoutNameHolder:t.types_by_index.find(e=>"LayoutNameHolder"===e.name||e.plugin instanceof cr.plugins_.Sprite&&e.all_frames&&e.all_frames[0].texture_file.includes("layoutnameholder")),LayoutNumber:t.types_by_index.find(e=>"LayoutNumber"===e.name||e.plugin instanceof cr.plugins_.SkymenSFPlusPLus&&e.texture_file&&e.texture_file.includes("layoutnumber")),LayoutSubtitle:t.types_by_index.find(e=>"LayoutSubtitle"===e.name||e.plugin instanceof cr.plugins_.Sprite&&e.all_frames&&e.all_frames[0].texture_file.includes("layoutsubtitle"))},n={"Layer 0":i.layers.find(e=>"Layer 0"===e.name),Background:i.layers.find(e=>"Background"===e.name)},r=(e,i,{x:l,y:a,width:r,height:o,angle:u})=>{let d=t.createInstance(s[e],n[i],l,a);return d.width=r||d.width,d.height=o||d.height,d.angle=u||d.angle,d.set_bbox_changed(),d};globalThis.ovoLevelEditor={startLevel(e){t.types_by_index.find(e=>"Globals"===e.name||e.plugin instanceof cr.plugins_.Globals&&e.instvar_sids.length>20).instances[0].instance_vars[3]=1,this.curLevel=e,a()},wipeAllInstances(){Object.values(n).forEach(e=>{e&&(console.log("wiping "+e),e.instances.filter(e=>Object.values(s).includes(e.type)).forEach(t.DestroyInstance.bind(t)))})},getPlayer:()=>t.types_by_index.filter(e=>!!e.animations&&e.animations[0].frames[0].texture_file.includes("collider"))[0].instances.filter(e=>""===e.instance_vars[17]&&e.behavior_insts[0].enabled)[0],async awaitForPlayer(){let e=this.getPlayer();for(;!e;)await new Promise(e=>setTimeout(e,20)),e=this.getPlayer();return e},async setPlayerPosition(e,t){let i=this.getPlayer();for(;!i;)await new Promise(e=>setTimeout(e,20)),i=this.getPlayer();e&&(i.x=e),t&&(i.y=t),i.set_bbox_changed()},applySetup(){this.curLevel&&this.curLevel.layout&&(this.curLevel.layout.width&&(i.originalWidth=this.curLevel.layout.width,i.width=this.curLevel.layout.width),this.curLevel.layout.height&&(i.originalHeight=this.curLevel.layout.height,i.height=this.curLevel.layout.height))},async applyCurrentLevel(){if(!this.curLevel)return;if(this.wipeAllInstances(),await this.awaitForPlayer(),this.curLevel.player&&this.setPlayerPosition(this.curLevel.player.x,this.curLevel.player.y),Object.keys(this.curLevel.layers).forEach(e=>{n[e]&&Object.keys(this.curLevel.layers[e]).forEach(i=>{s[i]&&this.curLevel.layers[e][i].forEach(l=>{let a=r(i,e,l);t.trigger(a.type.plugin.cnds.OnCreated,a)})})}),t.trigger(t.system.cnds.OnLayoutStart),this.curLevel.layout.holder&&"number"==typeof this.curLevel.layout.holder.x){let e=r("LayoutNumber","Layer 0",this.curLevel.layout.holder);t.trigger(e.type.plugin.cnds.OnCreated,e),"number"==typeof this.curLevel.layout.number?e.text=this.curLevel.layout.number.toString():e.text="1"}let i=r("LayoutNameHolder","Layer 0",{x:-500,y:-500});i.instance_vars[0]=this.curLevel.layout.name||"",i.instance_vars[2]=!!this.curLevel.layout.useSlope,t.trigger(i.type.plugin.cnds.OnCreated,i)},handleDrop(e){console.log("File(s) dropped"),e.preventDefault();let t=e=>{console.log(e),e.text().then(e=>{console.log(e);try{let t=JSON.parse(e);globalThis.ovoLevelEditor.startLevel&&globalThis.ovoLevelEditor.startLevel(t)}catch(i){alert("not a valid level file")}})};if(e.dataTransfer.items){for(var i=0;i<e.dataTransfer.items.length;i++)if("file"===e.dataTransfer.items[i].kind){t(e.dataTransfer.items[i].getAsFile());break}}else t(e.dataTransfer.files[0])}},t.canvas.setAttribute("ondragover","event.preventDefault();"),t.canvas.setAttribute("ondrop","ovoLevelEditor.handleDrop(event)")}};let e=e=>{if(e.data.isLevelEditor&&e.data.messageType&&("isready"===e.data.messageType.toLowerCase()&&e.source.postMessage({isReady:!globalThis.ovoLevelEditor.hasOwnProperty("init"),isLevelEditor:!0,messageType:e.data.messageType},e.origin),"startlevel"===e.data.messageType.toLowerCase())){if(globalThis.ovoLevelEditor.hasOwnProperty("init")){e.source.postMessage({levelStarted:!1,isLevelEditor:!0,messageType:e.data.messageType},e.origin);return}globalThis.ovoLevelEditor.startLevel(e.data.level),e.source.postMessage({levelStarted:!0,isLevelEditor:!0,messageType:e.data.messageType},e.origin)}};globalThis.window.addEventListener("message",e)})();